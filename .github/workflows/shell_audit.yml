name: Auditor√≠a y Auto-Formato Shell

on: [push, pull_request]

permissions:
  contents: write

jobs:
  shell-quality:
    name: Estilo (Auto) y Seguridad (Manual)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Instalar ShellCheck y Shfmt
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck shfmt

      # --- PASO 1: ESTILO (Auto-Commit) ---
      - name: Aplicar shfmt y Auto-Commit
        id: format_step
        run: |
          find . -type f -name "*.sh" -exec shfmt -w {} +
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

          if ! git diff --exit-code; then
            git add .
            git commit -m "style(sh): auto-formato aplicado con shfmt"
            git push
            echo "estilo_cambiado=true" >> $GITHUB_OUTPUT
          else
            echo "estilo_cambiado=false" >> $GITHUB_OUTPUT
          fi

      # --- PASO 2: SEGURIDAD (GENERACI√ìN DE PARCHES GARANTIZADA) ---
      - name: Auditor√≠a de Seguridad con ShellCheck
        id: audit_step
        run: |
          mkdir -p parches_seguridad
          HUBO_ERRORES=false
          HUBO_PARCHES=false
          LISTA_SIN_PARCHE=""

          while IFS= read -r archivo; do
            # 1. Ejecutamos ShellCheck normal para ver si hay errores
            if ! shellcheck "$archivo"; then
              HUBO_ERRORES=true
              
              nombre_archivo=$(basename "$archivo")
              ruta_parche="parches_seguridad/${nombre_archivo}.patch"
              
              # 2. Intentamos generar el parche. 
              # Forzamos la creaci√≥n del archivo e ignoramos el exit code de shellcheck
              shellcheck -f diff "$archivo" > "$ruta_parche" 2>/dev/null || true
              
              # 3. COMPROBACI√ìN CR√çTICA: ¬øEl parche tiene contenido real?
              if [ -s "$ruta_parche" ]; then
                HUBO_PARCHES=true
                echo "‚úÖ Parche generado para $archivo"
              else
                rm -f "$ruta_parche"
                LISTA_SIN_PARCHE="$LISTA_SIN_PARCHE $archivo"
                echo "‚ö†Ô∏è No se pudo generar parche autom√°tico para $archivo"
              fi
            fi
          done < <(find . -type f -name "*.sh")

          echo "hubo_errores=$HUBO_ERRORES" >> $GITHUB_OUTPUT
          echo "hubo_parches=$HUBO_PARCHES" >> $GITHUB_OUTPUT
          echo "lista_sin_parche=$LISTA_SIN_PARCHE" >> $GITHUB_OUTPUT

      # --- PASO 3: SUBIDA DE ARTEFACTOS ---
      - name: Subir Parches
        if: steps.audit_step.outputs.hubo_parches == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: parches-de-seguridad
          path: parches_seguridad/*.patch

      # --- PASO 4: REPORTE FINAL ---
      - name: Verificar Resultado Final
        run: |
          echo "=========================================================="
          
          if [ "${{ steps.format_step.outputs.estilo_cambiado }}" == "true" ]; then
            echo "‚úÖ El estilo se arregl√≥ autom√°ticamente."
          else
            echo "‚úÖ El estilo ya era correcto, no hubo cambios."
          fi

          if [ "${{ steps.audit_step.outputs.hubo_errores }}" == "true" ]; then
            echo "‚ùå ShellCheck encontr√≥ problemas de seguridad/l√≥gica."
            
            if [ "${{ steps.audit_step.outputs.hubo_parches }}" == "true" ]; then
              echo "üì© Descarga los parches en la pesta√±a 'Actions' para corregirlos autom√°ticamente."
            fi

            ARCHIVOS_MANUALES="${{ steps.audit_step.outputs.lista_sin_parche }}"
            if [ ! -z "$ARCHIVOS_MANUALES" ]; then
              echo ""
              echo "Archivos con errores que requieren intervenci√≥n MANUAL (sin parche):"
              for archivo in $ARCHIVOS_MANUALES; do
                echo "----------------------------------------------------------"
                echo "üìÑ ARCHIVO: $archivo"
                shellcheck "$archivo" || true
              done
            fi
            
            echo "=========================================================="
            exit 1
          else
            echo "‚úÖ ShellCheck no encontr√≥ errores de seguridad."
            echo "=========================================================="
          fi
