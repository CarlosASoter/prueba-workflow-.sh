name: Auditor√≠a y Auto-Formato Shell

on: [push, pull_request]

permissions:
  contents: write

jobs:
  shell-quality:
    name: Estilo (Auto) y Seguridad (Manual)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Instalar ShellCheck y Shfmt
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck shfmt

      # --- PASO 1: ESTILO (Auto-Commit) ---
      - name: Aplicar shfmt y Auto-Commit
        id: format_step
        run: |
          find . -type f -name "*.sh" -exec shfmt -w {} +
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

          if ! git diff --exit-code; then
            git add .
            git commit -m "style(sh): auto-formato aplicado con shfmt"
            git push
          fi

      # --- PASO 2: SEGURIDAD CON REPORTE VISUAL ---
      - name: Auditor√≠a de Seguridad con ShellCheck
        id: audit_step
        run: |
          mkdir -p parches_seguridad
          HUBO_ERRORES=false
          
          # Crear encabezado del resumen en la pantalla principal de GitHub
          echo "### üõ°Ô∏è Reporte de Auditor√≠a Shell" >> $GITHUB_STEP_SUMMARY
          echo "| Archivo | Estado | Parche Auto | Acci√≥n Recomendada |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY

          while IFS= read -r archivo; do
            nombre_archivo=$(basename "$archivo")
            ruta_parche="parches_seguridad/${nombre_archivo}.patch"
            
            # Ejecutar shellcheck
            if shellcheck "$archivo" > /dev/null 2>&1; then
              echo "| $archivo | ‚úÖ Limpio | - | Ninguna |" >> $GITHUB_STEP_SUMMARY
            else
              HUBO_ERRORES=true
              
              # Intentar generar parche
              if shellcheck -f diff "$archivo" > "$ruta_parche" 2>/dev/null && [ -s "$ruta_parche" ]; then
                PARCHE_MSG="üéÅ Generado"
                ACCION="Descargar parche en 'Artifacts'"
              else
                rm -f "$ruta_parche"
                PARCHE_MSG="‚ö†Ô∏è No disponible"
                ACCION="Corregir manualmente (ver logs)"
              fi
              
              echo "| $archivo | ‚ùå Errores | $PARCHE_MSG | $ACCION |" >> $GITHUB_STEP_SUMMARY
              
              # Esto crea una anotaci√≥n roja directamente en la pesta√±a "Files changed"
              echo "::error file=$archivo::Se detectaron errores de seguridad o l√≥gica. Revisa el Summary del Job."
              
              # Imprimir el error en el log por si acaso
              echo "--- Errores detallados para $archivo ---"
              shellcheck "$archivo"
            fi

          done < <(find . -type f -name "*.sh")

          if [ "$HUBO_ERRORES" = true ]; then
            echo "status=fail" >> $GITHUB_OUTPUT
          fi

      # --- PASO 3: SUBIDA DE ARTEFACTOS ---
      - name: Subir Parches
        if: steps.audit_step.outputs.status == 'fail'
        uses: actions/upload-artifact@v4
        with:
          name: parches-de-seguridad
          path: parches_seguridad/*.patch
          retention-days: 5

      - name: Verificar Resultado Final
        if: steps.audit_step.outputs.status == 'fail'
        run: |
          echo "‚ùå La auditor√≠a fall√≥. Revisa la tabla resumen en la pesta√±a 'Summary'."
          exit 1
